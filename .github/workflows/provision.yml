name: Provision New Site

on:
  workflow_dispatch:
    inputs:
      subdomain:
        description: '서브도메인 (예: my-docs)'
        required: true
        type: string
      title:
        description: '사이트 제목'
        required: true
        type: string
      topic:
        description: '문서 주제 (예: React 학습 가이드)'
        required: true
        type: string
      accent_color:
        description: '테마 색상 (예: #3b82f6)'
        required: true
        type: string

env:
  TEMPLATE_REPO: replica-template-00
  FORKED_REPO_PREFIX: replica-template-00
  GITHUB_OWNER: xiyo

jobs:
  provision:
    runs-on: ubuntu-latest
    steps:
      - name: Create repo from template
        uses: actions/github-script@v7
        id: fork
        with:
          github-token: ${{ secrets.PROVISION_TOKEN }}
          script: |
            const now = new Date();
            const timestamp = now.toISOString().replace(/[-:T]/g, '').slice(0, 14);
            const newRepoName = `${{ env.FORKED_REPO_PREFIX }}-${timestamp}`;
            const { data: repo } = await github.rest.repos.createUsingTemplate({
              template_owner: 'xiyo',
              template_repo: '${{ env.TEMPLATE_REPO }}',
              owner: '${{ env.GITHUB_OWNER }}',
              name: newRepoName,
              include_all_branches: false,
            });
            console.log(`Created from template: ${repo.full_name}`);
            core.setOutput('fork_repo', repo.full_name);
            core.setOutput('fork_name', newRepoName);

      - name: Set GitHub Secrets on forked repo
        env:
          GH_TOKEN: ${{ secrets.PROVISION_TOKEN }}
        run: |
          gh secret set CLOUDFLARE_API_KEY \
            --repo ${{ env.GITHUB_OWNER }}/${{ steps.fork.outputs.fork_name }} \
            --body "${{ secrets.CLOUDFLARE_API_KEY }}"
          gh secret set CLOUDFLARE_EMAIL \
            --repo ${{ env.GITHUB_OWNER }}/${{ steps.fork.outputs.fork_name }} \
            --body "${{ secrets.CLOUDFLARE_EMAIL }}"
          gh secret set CLOUDFLARE_ACCOUNT_ID \
            --repo ${{ env.GITHUB_OWNER }}/${{ steps.fork.outputs.fork_name }} \
            --body "${{ secrets.CLOUDFLARE_ACCOUNT_ID }}"
          gh secret set CLOUDFLARE_ZONE_ID \
            --repo ${{ env.GITHUB_OWNER }}/${{ steps.fork.outputs.fork_name }} \
            --body "${{ secrets.CLOUDFLARE_ZONE_ID }}"

      - name: Set GitHub Variables on forked repo
        env:
          GH_TOKEN: ${{ secrets.PROVISION_TOKEN }}
        run: |
          gh variable set SITE_SUBDOMAIN \
            --repo ${{ env.GITHUB_OWNER }}/${{ steps.fork.outputs.fork_name }} \
            --body "${{ inputs.subdomain }}"
          gh variable set SITE_TITLE \
            --repo ${{ env.GITHUB_OWNER }}/${{ steps.fork.outputs.fork_name }} \
            --body "${{ inputs.title }}"
          gh variable set ACCENT_COLOR \
            --repo ${{ env.GITHUB_OWNER }}/${{ steps.fork.outputs.fork_name }} \
            --body "${{ inputs.accent_color }}"

      - name: Wait for repo to be ready
        run: sleep 5

      - name: Checkout replica-builder (for generate.ts)
        uses: actions/checkout@v6
        with:
          path: builder

      - name: Checkout forked repo
        uses: actions/checkout@v6
        with:
          repository: ${{ env.GITHUB_OWNER }}/${{ steps.fork.outputs.fork_name }}
          token: ${{ secrets.PROVISION_TOKEN }}
          path: site

      - name: Update site.config.json
        run: |
          cat > site/site.config.json << EOF
          {
            "subdomain": "${{ inputs.subdomain }}",
            "title": "${{ inputs.title }}",
            "accentColor": "${{ inputs.accent_color }}",
            "githubRepo": "${{ env.GITHUB_OWNER }}/${{ steps.fork.outputs.fork_name }}"
          }
          EOF

      - name: Create custom CSS with accent color
        run: |
          mkdir -p site/src/styles
          cat > site/src/styles/custom.css << EOF
          :root {
            --sl-color-accent-low: ${{ inputs.accent_color }}33;
            --sl-color-accent: ${{ inputs.accent_color }};
            --sl-color-accent-high: ${{ inputs.accent_color }}dd;
          }
          EOF

      - name: Setup Deno
        uses: denoland/setup-deno@v2

      - name: Remove default content
        run: |
          rm -rf site/src/content/docs/guides
          rm -rf site/src/content/docs/reference
          rm -f site/src/content/docs/index.mdx

      - name: Generate initial content with AI
        working-directory: site
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          deno run --allow-net --allow-write --allow-env --allow-read \
            ../builder/scripts/generate.ts "${{ inputs.topic }}"

      - name: Commit and push changes
        working-directory: site
        run: |
          git config user.name "Replica Builder Bot"
          git config user.email "bot@xiyo.dev"
          git add -A
          git commit -m "feat: initialize ${{ inputs.title }} site

          Provisioned by Replica Builder
          - Subdomain: ${{ inputs.subdomain }}
          - Topic: ${{ inputs.topic }}
          - Accent Color: ${{ inputs.accent_color }}"
          git push

      - name: Output result
        run: |
          echo "Site provisioned successfully!"
          echo ""
          echo "URL: https://${{ inputs.subdomain }}.xiyo.dev"
          echo "Repo: https://github.com/${{ env.GITHUB_OWNER }}/${{ steps.fork.outputs.fork_name }}"
          echo ""
          echo "Deployment will start automatically via GitHub Actions."
