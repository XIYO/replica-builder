name: Provision New Site

on:
  workflow_dispatch:
    inputs:
      config:
        description: 'Site configuration (JSON)'
        required: true
        type: string

env:
  GITHUB_OWNER: xiyo

jobs:
  provision:
    runs-on: ubuntu-latest
    steps:
      - name: Parse config
        id: config
        run: |
          echo '${{ inputs.config }}' > config.json
          # template 값 추출 (기본값: replica-template-00)
          TEMPLATE_REPO=$(jq -r '.template // "replica-template-00"' config.json)
          {
            echo "subdomain=$(jq -r '.subdomain' config.json)"
            echo "title=$(jq -r '.title' config.json)"
            echo "topic=$(jq -r '.topic' config.json)"
            echo "template=${TEMPLATE_REPO}"
            echo "templateRepo=${TEMPLATE_REPO}"
            echo "accentColor=$(jq -r '.accentColor // "#3b82f6"' config.json)"
            echo "description=$(jq -r '.description // ""' config.json)"
            echo "locale=$(jq -r '.locale // "ko"' config.json)"
            echo "tableOfContents=$(jq -r '.tableOfContents // true' config.json)"
            echo "lastUpdated=$(jq -r '.lastUpdated // false' config.json)"
          } >> "$GITHUB_OUTPUT"

      - name: Create repo from template
        uses: actions/github-script@v7
        id: fork
        with:
          github-token: ${{ secrets.PROVISION_TOKEN }}
          script: |
            const now = new Date();
            const timestamp = now.toISOString().replace(/[-:T]/g, '').slice(0, 14);
            const templateRepo = '${{ steps.config.outputs.templateRepo }}';
            const newRepoName = `${templateRepo}-${timestamp}`;
            const { data: repo } = await github.rest.repos.createUsingTemplate({
              template_owner: 'xiyo',
              template_repo: templateRepo,
              owner: '${{ env.GITHUB_OWNER }}',
              name: newRepoName,
              include_all_branches: false,
            });
            console.log(`Created from template: ${repo.full_name}`);
            core.setOutput('fork_repo', repo.full_name);
            core.setOutput('fork_name', newRepoName);

      - name: Set GitHub Secrets on forked repo
        env:
          GH_TOKEN: ${{ secrets.PROVISION_TOKEN }}
        run: |
          gh secret set CLOUDFLARE_API_KEY \
            --repo ${{ env.GITHUB_OWNER }}/${{ steps.fork.outputs.fork_name }} \
            --body "${{ secrets.CLOUDFLARE_API_KEY }}"
          gh secret set CLOUDFLARE_EMAIL \
            --repo ${{ env.GITHUB_OWNER }}/${{ steps.fork.outputs.fork_name }} \
            --body "${{ secrets.CLOUDFLARE_EMAIL }}"
          gh secret set CLOUDFLARE_ACCOUNT_ID \
            --repo ${{ env.GITHUB_OWNER }}/${{ steps.fork.outputs.fork_name }} \
            --body "${{ secrets.CLOUDFLARE_ACCOUNT_ID }}"
          gh secret set CLOUDFLARE_ZONE_ID \
            --repo ${{ env.GITHUB_OWNER }}/${{ steps.fork.outputs.fork_name }} \
            --body "${{ secrets.CLOUDFLARE_ZONE_ID }}"

      - name: Set GitHub Variables on forked repo
        env:
          GH_TOKEN: ${{ secrets.PROVISION_TOKEN }}
        run: |
          gh variable set SITE_SUBDOMAIN \
            --repo ${{ env.GITHUB_OWNER }}/${{ steps.fork.outputs.fork_name }} \
            --body "${{ steps.config.outputs.subdomain }}"
          gh variable set SITE_TITLE \
            --repo ${{ env.GITHUB_OWNER }}/${{ steps.fork.outputs.fork_name }} \
            --body "${{ steps.config.outputs.title }}"
          gh variable set ACCENT_COLOR \
            --repo ${{ env.GITHUB_OWNER }}/${{ steps.fork.outputs.fork_name }} \
            --body "${{ steps.config.outputs.accentColor }}"

      - name: Wait for repo to be ready
        run: sleep 5

      - name: Checkout replica-builder (for generate.ts)
        uses: actions/checkout@v6
        with:
          path: builder

      - name: Checkout forked repo
        uses: actions/checkout@v6
        with:
          repository: ${{ env.GITHUB_OWNER }}/${{ steps.fork.outputs.fork_name }}
          token: ${{ secrets.PROVISION_TOKEN }}
          path: site

      - name: Update site.config.json
        run: |
          cat > site/site.config.json << 'EOF'
          ${{ inputs.config }}
          EOF
          jq '. + {"githubRepo": "${{ env.GITHUB_OWNER }}/${{ steps.fork.outputs.fork_name }}"}' \
            site/site.config.json > site/site.config.json.tmp
          mv site/site.config.json.tmp site/site.config.json

      # Starlight (template-00) 전용 단계들
      - name: Create custom CSS with accent color (Starlight)
        if: steps.config.outputs.template == 'replica-template-00'
        run: |
          mkdir -p site/src/styles
          cat > site/src/styles/custom.css << EOF
          :root {
            --sl-color-accent-low: ${{ steps.config.outputs.accentColor }}33;
            --sl-color-accent: ${{ steps.config.outputs.accentColor }};
            --sl-color-accent-high: ${{ steps.config.outputs.accentColor }}dd;
          }
          EOF

      - name: Setup Deno (Starlight)
        if: steps.config.outputs.template == 'replica-template-00'
        uses: denoland/setup-deno@v2

      - name: Remove default content (Starlight)
        if: steps.config.outputs.template == 'replica-template-00'
        run: |
          rm -rf site/src/content/docs/guides
          rm -rf site/src/content/docs/reference
          rm -f site/src/content/docs/index.mdx

      - name: Generate initial content with AI (Starlight)
        if: steps.config.outputs.template == 'replica-template-00'
        working-directory: site
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          deno run --allow-net --allow-write --allow-env --allow-read \
            ../builder/scripts/generate.ts "${{ steps.config.outputs.topic }}"

      - name: Commit and push changes
        working-directory: site
        run: |
          git config user.name "Replica Builder Bot"
          git config user.email "bot@xiyo.dev"
          git add -A
          git commit -m "feat: initialize ${{ steps.config.outputs.title }} site

          Provisioned by Replica Builder
          - Template: ${{ steps.config.outputs.template }}
          - Subdomain: ${{ steps.config.outputs.subdomain }}
          - Topic: ${{ steps.config.outputs.topic }}
          - Accent Color: ${{ steps.config.outputs.accentColor }}"
          git push

      - name: Output result
        run: |
          echo "Site provisioned successfully!"
          echo ""
          echo "URL: https://${{ steps.config.outputs.subdomain }}.xiyo.dev"
          echo "Repo: https://github.com/${{ env.GITHUB_OWNER }}/${{ steps.fork.outputs.fork_name }}"
          echo ""
          echo "Deployment will start automatically via GitHub Actions."
